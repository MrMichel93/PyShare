<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PyShare Test Suite</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }

    h2 {
      color: #34495e;
      margin-top: 30px;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    .test-summary {
      display: flex;
      gap: 20px;
      margin: 20px 0;
      padding: 15px;
      background: #ecf0f1;
      border-radius: 5px;
    }

    .test-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .test-stat-value {
      font-size: 2em;
      font-weight: bold;
    }

    .test-stat-label {
      font-size: 0.9em;
      color: #7f8c8d;
    }

    .passed {
      color: #27ae60;
    }

    .failed {
      color: #e74c3c;
    }

    .skipped {
      color: #f39c12;
    }

    .test-case {
      margin: 10px 0;
      padding: 12px;
      border-left: 4px solid #bdc3c7;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .test-case.pass {
      border-left-color: #27ae60;
      background: #d5f4e6;
    }

    .test-case.fail {
      border-left-color: #e74c3c;
      background: #fadbd8;
    }

    .test-case.skip {
      border-left-color: #f39c12;
      background: #fef5e7;
    }

    .test-name {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .test-error {
      color: #c0392b;
      font-family: monospace;
      font-size: 0.9em;
      margin-top: 5px;
      padding: 8px;
      background: #fff;
      border-radius: 3px;
      white-space: pre-wrap;
    }

    .test-duration {
      font-size: 0.85em;
      color: #7f8c8d;
      margin-top: 5px;
    }

    .run-tests-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 20px 0;
    }

    .run-tests-btn:hover {
      background: #2980b9;
    }

    .run-tests-btn:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    #test-iframe {
      width: 1px;
      height: 1px;
      border: none;
      position: absolute;
      left: -9999px;
    }

    .loading {
      display: inline-block;
      margin-left: 10px;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .manual-test-section {
      margin-top: 30px;
      padding: 20px;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 4px;
    }

    .manual-test-item {
      margin: 10px 0;
      padding-left: 20px;
    }

    .checklist {
      list-style: none;
      padding-left: 0;
    }

    .checklist li {
      padding: 8px 0;
      padding-left: 30px;
      position: relative;
    }

    .checklist li:before {
      content: "‚òê";
      position: absolute;
      left: 0;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PyShare Test Suite</h1>
    <p>Comprehensive automated and manual testing for the Python code editor</p>

    <button class="run-tests-btn" id="runTestsBtn" onclick="runAllTests()">
      Run Automated Tests
      <span class="loading" id="loadingSpinner" style="display: none;">
        <span class="spinner"></span>
      </span>
    </button>

    <div class="test-summary" id="testSummary" style="display: none;">
      <div class="test-stat">
        <div class="test-stat-value passed" id="passedCount">0</div>
        <div class="test-stat-label">Passed</div>
      </div>
      <div class="test-stat">
        <div class="test-stat-value failed" id="failedCount">0</div>
        <div class="test-stat-label">Failed</div>
      </div>
      <div class="test-stat">
        <div class="test-stat-value" id="totalCount">0</div>
        <div class="test-stat-label">Total</div>
      </div>
      <div class="test-stat">
        <div class="test-stat-value" id="durationCount">0ms</div>
        <div class="test-stat-label">Duration</div>
      </div>
    </div>

    <div id="testResults"></div>

    <div class="manual-test-section">
      <h2>üìã Manual Test Cases</h2>
      <p>These tests should be performed manually across different browsers and devices:</p>
      
      <h3>Cross-Browser Testing</h3>
      <ul class="checklist">
        <li>Test in Chrome/Chromium (latest)</li>
        <li>Test in Firefox (latest)</li>
        <li>Test in Safari (latest)</li>
        <li>Test in Edge (latest)</li>
        <li>Test on mobile browsers (iOS Safari, Chrome Mobile)</li>
      </ul>

      <h3>Responsiveness Testing</h3>
      <ul class="checklist">
        <li>Test on desktop (1920x1080, 1366x768)</li>
        <li>Test on tablet (iPad, Android tablet)</li>
        <li>Test on mobile (iPhone, Android phone)</li>
        <li>Verify UI elements are accessible at all sizes</li>
        <li>Verify menu doesn't overflow on small screens</li>
      </ul>

      <h3>Feature Testing</h3>
      <ul class="checklist">
        <li>Verify syntax highlighting updates as you type</li>
        <li>Test Python code execution with various scripts</li>
        <li>Test linting with intentional syntax errors</li>
        <li>Share a document and verify URL loads correctly</li>
        <li>Test save/load .py files functionality</li>
        <li>Verify output console shows correct results and errors</li>
        <li>Test theme toggle (light/dark mode)</li>
        <li>Test URL length warnings for large documents</li>
        <li>Test QR code generation</li>
        <li>Test keyboard shortcuts (Ctrl+S, Tab completion, etc.)</li>
      </ul>

      <h3>Edge Cases</h3>
      <ul class="checklist">
        <li>Test with very large Python files (&gt;10,000 lines)</li>
        <li>Test with empty document</li>
        <li>Test with Unicode characters</li>
        <li>Test with malformed Python code</li>
        <li>Test offline functionality (service worker)</li>
      </ul>
    </div>
  </div>

  <iframe id="test-iframe" src="about:blank"></iframe>

  <script>
    // Test Framework
    class TestRunner {
      constructor() {
        this.tests = [];
        this.results = [];
        this.totalDuration = 0;
      }

      describe(category, tests) {
        this.tests.push({ category, tests });
      }

      async runAll() {
        this.results = [];
        this.totalDuration = 0;
        const startTime = performance.now();

        for (const suite of this.tests) {
          const suiteResults = {
            category: suite.category,
            tests: []
          };

          for (const test of suite.tests) {
            const testStart = performance.now();
            let result = {
              name: test.name,
              status: 'pass',
              error: null,
              duration: 0
            };

            try {
              await test.fn();
            } catch (error) {
              result.status = 'fail';
              result.error = error.message || error.toString();
            }

            result.duration = performance.now() - testStart;
            suiteResults.tests.push(result);
          }

          this.results.push(suiteResults);
        }

        this.totalDuration = performance.now() - startTime;
        return this.results;
      }

      getStats() {
        let passed = 0;
        let failed = 0;
        let total = 0;

        this.results.forEach(suite => {
          suite.tests.forEach(test => {
            total++;
            if (test.status === 'pass') passed++;
            else if (test.status === 'fail') failed++;
          });
        });

        return { passed, failed, total, duration: this.totalDuration };
      }
    }

    // Assertion helpers
    function assert(condition, message) {
      if (!condition) {
        throw new Error(message || 'Assertion failed');
      }
    }

    function assertEquals(actual, expected, message) {
      if (actual !== expected) {
        throw new Error(message || `Expected ${expected} but got ${actual}`);
      }
    }

    function assertContains(haystack, needle, message) {
      if (!haystack.includes(needle)) {
        throw new Error(message || `Expected to contain "${needle}" but got "${haystack}"`);
      }
    }

    function assertNotNull(value, message) {
      if (value === null || value === undefined) {
        throw new Error(message || 'Expected non-null value');
      }
    }

    function assertTrue(condition, message) {
      if (!condition) {
        throw new Error(message || 'Expected true but got false');
      }
    }

    function assertFalse(condition, message) {
      if (condition) {
        throw new Error(message || 'Expected false but got true');
      }
    }

    // Test utilities
    async function loadIndexPage() {
      return new Promise((resolve, reject) => {
        const iframe = document.getElementById('test-iframe');
        iframe.onload = () => {
          // Wait a bit for scripts to initialize
          setTimeout(() => resolve(iframe), 100);
        };
        iframe.onerror = reject;
        iframe.src = './index.html';
      });
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Initialize test runner
    const runner = new TestRunner();

    // Test Suite 1: Python Syntax Highlighting
    runner.describe('Python Syntax Highlighting', [
      {
        name: 'Highlights Python keywords correctly',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          const article = doc.querySelector('article');
          
          // Set Python code
          article.textContent = 'def hello():\n    return True';
          
          // Trigger highlighting by dispatching input event
          const event = new Event('input', { bubbles: true });
          article.dispatchEvent(event);
          
          // Wait for highlighting to complete
          await sleep(100);
          
          // Check for keyword highlighting
          const keywords = doc.querySelectorAll('.py-keyword');
          assertTrue(keywords.length > 0, 'Should have highlighted keywords');
        }
      },
      {
        name: 'Highlights Python strings correctly',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          const article = doc.querySelector('article');
          
          article.textContent = 'message = "Hello World"';
          const event = new Event('input', { bubbles: true });
          article.dispatchEvent(event);
          await sleep(100);
          
          const strings = doc.querySelectorAll('.py-string');
          assertTrue(strings.length > 0, 'Should have highlighted strings');
        }
      },
      {
        name: 'Highlights Python comments correctly',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          const article = doc.querySelector('article');
          
          article.textContent = '# This is a comment\nprint("test")';
          const event = new Event('input', { bubbles: true });
          article.dispatchEvent(event);
          await sleep(100);
          
          const comments = doc.querySelectorAll('.py-comment');
          assertTrue(comments.length > 0, 'Should have highlighted comments');
        }
      },
      {
        name: 'Highlights Python numbers correctly',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          const article = doc.querySelector('article');
          
          article.textContent = 'x = 42\ny = 3.14';
          const event = new Event('input', { bubbles: true });
          article.dispatchEvent(event);
          await sleep(100);
          
          const numbers = doc.querySelectorAll('.py-number');
          assertTrue(numbers.length > 0, 'Should have highlighted numbers');
        }
      },
      {
        name: 'Highlights function definitions correctly',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          const article = doc.querySelector('article');
          
          article.textContent = 'def my_function():\n    pass';
          const event = new Event('input', { bubbles: true });
          article.dispatchEvent(event);
          await sleep(100);
          
          const functions = doc.querySelectorAll('.py-function');
          assertTrue(functions.length > 0, 'Should have highlighted function names');
        }
      },
      {
        name: 'Highlights class definitions correctly',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          const article = doc.querySelector('article');
          
          article.textContent = 'class MyClass:\n    pass';
          const event = new Event('input', { bubbles: true });
          article.dispatchEvent(event);
          await sleep(100);
          
          const classes = doc.querySelectorAll('.py-class');
          assertTrue(classes.length > 0, 'Should have highlighted class names');
        }
      },
      {
        name: 'Highlights built-in functions correctly',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          const article = doc.querySelector('article');
          
          article.textContent = 'print(len([1, 2, 3]))';
          const event = new Event('input', { bubbles: true });
          article.dispatchEvent(event);
          await sleep(100);
          
          const builtins = doc.querySelectorAll('.py-builtin');
          assertTrue(builtins.length > 0, 'Should have highlighted built-in functions');
        }
      }
    ]);

    // Test Suite 2: URL Sharing and Loading
    runner.describe('URL Sharing and Loading', [
      {
        name: 'Compresses and decompresses content correctly',
        fn: async () => {
          const iframe = await loadIndexPage();
          const win = iframe.contentWindow;
          
          const testText = 'print("Hello, World!")';
          const compressed = await win.compress(testText);
          
          assertNotNull(compressed, 'Should compress text');
          assertTrue(compressed.length > 0, 'Compressed text should not be empty');
          
          const decompressed = await win.decompress(compressed);
          assertEquals(decompressed, testText, 'Decompressed text should match original');
        }
      },
      {
        name: 'Updates URL hash when content changes',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          const win = iframe.contentWindow;
          const article = doc.querySelector('article');
          
          const originalHash = win.location.hash;
          article.textContent = 'def test():\n    return 42';
          
          // Trigger save
          await win.save();
          await sleep(200);
          
          const newHash = win.location.hash;
          assertTrue(newHash !== originalHash, 'Hash should change when content changes');
          assertTrue(newHash.length > 1, 'Hash should contain compressed content');
        }
      },
      {
        name: 'Loads content from URL hash',
        fn: async () => {
          const iframe = await loadIndexPage();
          const win = iframe.contentWindow;
          const doc = iframe.contentDocument;
          
          // Create a test hash
          const testContent = 'print("Test content")';
          const hash = '#' + await win.compress(testContent);
          
          // Set the hash and trigger load
          win.location.hash = hash;
          await win.load();
          await sleep(200);
          
          const article = doc.querySelector('article');
          assertEquals(article.textContent, testContent, 'Should load content from hash');
        }
      },
      {
        name: 'Warns when URL length exceeds threshold',
        fn: async () => {
          const iframe = await loadIndexPage();
          const win = iframe.contentWindow;
          
          // Create large content
          const largeContent = 'x = ' + '1234567890'.repeat(300);
          const hash = await win.compress(largeContent);
          const fullUrl = win.location.origin + win.location.pathname + '#' + hash;
          
          win.updateUrlSizeIndicator(fullUrl.length, win.URL_WARN_THRESHOLD, win.URL_MAX_THRESHOLD);
          
          const urlSize = iframe.contentDocument.querySelector('#url-size');
          assertTrue(urlSize.classList.contains('warning') || urlSize.classList.contains('error'), 
            'Should warn for large URLs');
        }
      }
    ]);

    // Test Suite 3: Save/Load Operations
    runner.describe('Save/Load Operations', [
      {
        name: 'Saves content to localStorage',
        fn: async () => {
          const iframe = await loadIndexPage();
          const win = iframe.contentWindow;
          const doc = iframe.contentDocument;
          const article = doc.querySelector('article');
          
          const testContent = 'def save_test():\n    return True';
          article.textContent = testContent;
          
          await win.save();
          await sleep(100);
          
          const savedHash = win.localStorage.getItem('hash');
          assertNotNull(savedHash, 'Should save hash to localStorage');
        }
      },
      {
        name: 'Download functions exist and are callable',
        fn: async () => {
          const iframe = await loadIndexPage();
          const win = iframe.contentWindow;
          
          assertTrue(typeof win.downloadHTML === 'function', 'downloadHTML should be a function');
          assertTrue(typeof win.downloadTXT === 'function', 'downloadTXT should be a function');
          assertTrue(typeof win.downloadPython === 'function', 'downloadPython should be a function');
        }
      }
    ]);

    // Test Suite 4: Output Console
    runner.describe('Output Console', [
      {
        name: 'Output console exists and can be shown',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          
          const outputConsole = doc.querySelector('#output-console');
          assertNotNull(outputConsole, 'Output console should exist');
          
          const outputContent = doc.querySelector('#output-content');
          assertNotNull(outputContent, 'Output content area should exist');
        }
      },
      {
        name: 'Output console close button works',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          
          const outputConsole = doc.querySelector('#output-console');
          const closeBtn = doc.querySelector('#output-console-close');
          
          assertNotNull(closeBtn, 'Close button should exist');
          
          // Show console
          outputConsole.classList.add('visible');
          assertTrue(outputConsole.classList.contains('visible'), 'Console should be visible');
          
          // Click close
          closeBtn.click();
          await sleep(100);
          
          assertFalse(outputConsole.classList.contains('visible'), 'Console should be hidden after close');
        }
      }
    ]);

    // Test Suite 5: UI Elements
    runner.describe('UI Elements', [
      {
        name: 'Menu button exists and toggles menu',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          
          const button = doc.querySelector('#button');
          const menu = doc.querySelector('#menu');
          
          assertNotNull(button, 'Menu button should exist');
          assertNotNull(menu, 'Menu should exist');
          
          button.click();
          await sleep(100);
          
          assertTrue(menu.classList.contains('visible'), 'Menu should be visible after click');
        }
      },
      {
        name: 'Theme toggle exists and works',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          
          const themeToggle = doc.querySelector('#theme-toggle');
          assertNotNull(themeToggle, 'Theme toggle should exist');
          
          const html = doc.documentElement;
          const initialClass = html.className;
          
          themeToggle.click();
          await sleep(100);
          
          const newClass = html.className;
          assertTrue(initialClass !== newClass || newClass.includes('theme-'), 
            'Theme should change after toggle');
        }
      },
      {
        name: 'All menu items exist',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          
          assertNotNull(doc.querySelector('#share-link'), 'Share link should exist');
          assertNotNull(doc.querySelector('#save-as-html'), 'Save as HTML should exist');
          assertNotNull(doc.querySelector('#save-as-text'), 'Save as TEXT should exist');
          assertNotNull(doc.querySelector('#save-as-python'), 'Save as Python should exist');
          assertNotNull(doc.querySelector('#load-python-file'), 'Load file should exist');
          assertNotNull(doc.querySelector('#run-python'), 'Run Python should exist');
          assertNotNull(doc.querySelector('#qr'), 'QR code link should exist');
        }
      },
      {
        name: 'Article element is editable',
        fn: async () => {
          const iframe = await loadIndexPage();
          const doc = iframe.contentDocument;
          const article = doc.querySelector('article');
          
          assertNotNull(article, 'Article element should exist');
          
          const contentEditable = article.getAttribute('contenteditable');
          assertEquals(contentEditable, 'plaintext-only', 'Article should be editable');
        }
      }
    ]);

    // Test Suite 6: Editor Functionality
    runner.describe('Editor Functionality', [
      {
        name: 'Editor initializes correctly',
        fn: async () => {
          const iframe = await loadIndexPage();
          const win = iframe.contentWindow;
          
          assertNotNull(win.editor, 'Editor object should exist');
          assertTrue(typeof win.editor.set === 'function', 'Editor should have set method');
          assertTrue(typeof win.editor.save === 'function', 'Editor should have save method');
          assertTrue(typeof win.editor.restore === 'function', 'Editor should have restore method');
        }
      },
      {
        name: 'Editor can set and get content',
        fn: async () => {
          const iframe = await loadIndexPage();
          const win = iframe.contentWindow;
          const doc = iframe.contentDocument;
          
          const testContent = 'print("Editor test")';
          win.editor.set(testContent);
          await sleep(100);
          
          const article = doc.querySelector('article');
          assertEquals(article.textContent, testContent, 'Editor should set content correctly');
        }
      },
      {
        name: 'parsePython function exists',
        fn: async () => {
          const iframe = await loadIndexPage();
          const win = iframe.contentWindow;
          
          assertTrue(typeof win.parsePython === 'function', 'parsePython function should exist');
        }
      }
    ]);

    // Run all tests
    async function runAllTests() {
      const btn = document.getElementById('runTestsBtn');
      const spinner = document.getElementById('loadingSpinner');
      const summary = document.getElementById('testSummary');
      const resultsDiv = document.getElementById('testResults');

      btn.disabled = true;
      spinner.style.display = 'inline-block';
      resultsDiv.innerHTML = '';
      summary.style.display = 'none';

      try {
        await runner.runAll();
        
        // Display results
        const stats = runner.getStats();
        document.getElementById('passedCount').textContent = stats.passed;
        document.getElementById('failedCount').textContent = stats.failed;
        document.getElementById('totalCount').textContent = stats.total;
        document.getElementById('durationCount').textContent = Math.round(stats.duration) + 'ms';
        summary.style.display = 'flex';

        // Display individual test results
        runner.results.forEach(suite => {
          const suiteDiv = document.createElement('div');
          suiteDiv.innerHTML = `<h2>${suite.category}</h2>`;
          
          suite.tests.forEach(test => {
            const testDiv = document.createElement('div');
            testDiv.className = `test-case ${test.status}`;
            
            let html = `<div class="test-name">${test.status === 'pass' ? '‚úì' : '‚úó'} ${test.name}</div>`;
            if (test.error) {
              html += `<div class="test-error">${test.error}</div>`;
            }
            html += `<div class="test-duration">${Math.round(test.duration)}ms</div>`;
            
            testDiv.innerHTML = html;
            suiteDiv.appendChild(testDiv);
          });
          
          resultsDiv.appendChild(suiteDiv);
        });

      } catch (error) {
        resultsDiv.innerHTML = `<div class="test-case fail">
          <div class="test-name">‚úó Test Suite Error</div>
          <div class="test-error">${error.message}</div>
        </div>`;
      } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
      }
    }

    // Auto-run tests on load if requested
    if (window.location.search.includes('autorun')) {
      window.addEventListener('load', () => {
        setTimeout(runAllTests, 500);
      });
    }
  </script>
</body>
</html>
